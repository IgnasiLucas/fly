---
title: "Initial Data Exploration"
author: "Ignasi"
date: "25/11/2019"
output: html_document
---

On 2019-11-14 I imported the reads into qiime2 and compared the already merged data to the results of
merging the clean reads with dada2 in qimme2. I decided to work from the reads that had already been
merged by the sequencing services with a program called FLASH. Here the goal is visualize the statistics
and main features of the dataset.

# De-noised statistics
Let's take a look first at the results of the de-noising process.

```{r visualize, cache=TRUE}
library(biomformat)
library(tidyr)
library(ggplot2)
DenoisedStats <- read.table('../2019-11-14/FromMerged/stats.tsv', skip=1, 
                            col.names=c('Sample','input','filtered','filtered.p','denoised',
                                        'trusted','trusted.p'),
                            colClasses=c('character', rep('numeric',6)))

DenoisedStats$time <- factor(NA, levels=c('early', 'late'))
DenoisedStats[grep("^E", DenoisedStats$Sample), 'time'] <- 'early'
DenoisedStats[grep("^L", DenoisedStats$Sample), 'time'] <- 'late'
m <- regexpr("[0-9]+", DenoisedStats$Sample)
DenoisedStats$isoline <- as.factor(regmatches(DenoisedStats$Sample, m))
DenoisedStats$excluded <- DenoisedStats$input - DenoisedStats$filtered
DenoisedStats$notDenoised <- DenoisedStats$filtered - DenoisedStats$denoised
DenoisedStats$untrusted <- DenoisedStats$denoised - DenoisedStats$trusted

ggplot(DenoisedStats, mapping=aes(x=time, y=trusted)) + geom_violin(trim=FALSE) + geom_jitter(width=0.05) +
  ggtitle('Number of non-chimeric reads per sample') + ylab('Number of reads')

LongStats <- gather(DenoisedStats, key="Fate", value="Reads", c('trusted','untrusted','notDenoised','excluded'))

ggplot(LongStats, mapping=aes(x=isoline, y=Reads, fill=Fate)) + geom_col() + facet_wrap(~time) +
  ggtitle('Total number of reads per isoline')
ggplot(LongStats, mapping=aes(x=Sample, y=Reads, fill=Fate)) + geom_col() +
  ggtitle('Total number of reads per sample') + theme(axis.text.x=element_text(angle=90,size=6))
```

# Features data

```{r biom}
Features <- read_biom('FeatureTable.biom')
# This would not work if the table was too big.
FeatDF <- as.data.frame(as.matrx(biom_data(Features)))

```